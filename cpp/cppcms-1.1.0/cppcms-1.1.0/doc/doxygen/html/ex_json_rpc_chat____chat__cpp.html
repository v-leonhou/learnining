<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>CppCMS: json_rpc_chat/chat.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CppCMS
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">CppCMS - C++ Web Development Framework</a></li><li class="navelem"><a class="el" href="examples_page.html">Examples</a></li><li class="navelem"><a class="el" href="ex_json_rpc_chat.html">Implementing chat using asynchronous JSON RPC calls</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">json_rpc_chat/chat.cpp Source File </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line"><span class="comment">//                                                                             </span></div><div class="line"><span class="comment">//  Copyright (C) 2008-2012  Artyom Beilis (Tonkikh) &lt;artyomtnk@yahoo.com&gt;     </span></div><div class="line"><span class="comment">//                                                                             </span></div><div class="line"><span class="comment">//  See accompanying file COPYING.TXT file for licensing details.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment"></span><span class="preprocessor">#include &lt;cppcms/application.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/url_dispatcher.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/applications_pool.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/service.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/http_response.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/http_request.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/http_context.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/rpc_json.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cppcms/json.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;booster/intrusive_ptr.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;booster/aio/deadline_timer.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;booster/system_error.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;set&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div><div class="line"><span class="keyword">using</span> boost::bind;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">class </span>chat : <span class="keyword">public</span> <a class="code" href="classcppcms_1_1rpc_1_1json__rpc__server.html">cppcms::rpc::json_rpc_server</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    chat(<a class="code" href="classcppcms_1_1service.html">cppcms::service</a> &amp;srv) : </div><div class="line">        <a class="code" href="namespacecppcms.html">cppcms</a>::rpc::json_rpc_server(srv),</div><div class="line">        timer_(srv.get_io_service())</div><div class="line">    {</div><div class="line">        <span class="comment">// Our main methods</span></div><div class="line">        <a class="code" href="classcppcms_1_1rpc_1_1json__rpc__server.html#a12dba74395bd011d5d123732e630c821">bind</a>(<span class="stringliteral">&quot;post&quot;</span>,cppcms::rpc::json_method(&amp;chat::post,<span class="keyword">this</span>),notification_role);</div><div class="line">        <a class="code" href="classcppcms_1_1rpc_1_1json__rpc__server.html#a12dba74395bd011d5d123732e630c821">bind</a>(<span class="stringliteral">&quot;get&quot;</span>,cppcms::rpc::json_method(&amp;chat::get,<span class="keyword">this</span>),method_role);</div><div class="line">        </div><div class="line">        <span class="comment">// Add timeouts to the system</span></div><div class="line">        last_wake_ = <a class="code" href="group__manipulators.html#ga7ef04454ad2736a51c55c3cd0270d80c">time</a>(0);</div><div class="line">        on_timer(<a class="code" href="classbooster_1_1system_1_1error__code.html">booster::system::error_code</a>());</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Handle new message call</span></div><div class="line">    <span class="keywordtype">void</span> post(std::string <span class="keyword">const</span> &amp;author,std::string <span class="keyword">const</span> &amp;<a class="code" href="group__message.html#gaf3f50828c78db8b38441f97a472e6725">message</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="classcppcms_1_1json_1_1value.html">cppcms::json::value</a> obj;</div><div class="line">        obj[<span class="stringliteral">&quot;author&quot;</span>]=author;</div><div class="line">        obj[<span class="stringliteral">&quot;message&quot;</span>]=<a class="code" href="group__message.html#gaf3f50828c78db8b38441f97a472e6725">message</a>;</div><div class="line">        messages_.push_back(obj);</div><div class="line">        broadcast(messages_.size()-1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> on_timer(<a class="code" href="classbooster_1_1system_1_1error__code.html">booster::system::error_code</a> <span class="keyword">const</span> &amp;e)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(e) <span class="keywordflow">return</span>; <span class="comment">// cancelation</span></div><div class="line"></div><div class="line">        <span class="comment">// check idle connections for more then 10 seconds</span></div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__manipulators.html#ga7ef04454ad2736a51c55c3cd0270d80c">time</a>(0) - last_wake_ &gt; 10) {</div><div class="line">            broadcast(messages_.size());</div><div class="line">        }</div><div class="line">        <span class="comment">// restart timer</span></div><div class="line">        timer_.expires_from_now(<a class="code" href="classbooster_1_1ptime.html#a5056017d41a4ace5d5c1efd6dba6b265">booster::ptime::seconds</a>(1));</div><div class="line">        timer_.async_wait(boost::bind(&amp;chat::on_timer,<a class="code" href="classbooster_1_1intrusive__ptr.html">booster::intrusive_ptr&lt;chat&gt;</a>(<span class="keyword">this</span>),_1));</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Handle request</span></div><div class="line">    <span class="keywordtype">void</span> <span class="keyword">get</span>(<span class="keywordtype">unsigned</span> from)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(from &lt; messages_.size()) {</div><div class="line">            <span class="comment">// not long polling - return result now</span></div><div class="line">            <a class="code" href="classcppcms_1_1rpc_1_1json__rpc__server.html#a18d9c7ff0aa2aef8fcb25400214c5f43">return_result</a>(make_response(from));</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(from == messages_.size()) {</div><div class="line">            <span class="comment">// Can&#39;t answer now</span></div><div class="line"></div><div class="line">            <span class="comment">// Add long polling request to the list</span></div><div class="line"></div><div class="line">            <a class="code" href="classbooster_1_1shared__ptr.html">booster::shared_ptr&lt;cppcms::rpc::json_call&gt;</a> call=<a class="code" href="classcppcms_1_1rpc_1_1json__rpc__server.html#a5280fefaa4610cab03a4eb1a3d84af1d">release_call</a>();</div><div class="line">            waiters_.insert(call);</div><div class="line"></div><div class="line">            <span class="comment">// set disconnect callback</span></div><div class="line">            call-&gt;<a class="code" href="classcppcms_1_1rpc_1_1json__call.html#a8ef7d2f3b159b76a4ce7ce87562427bd">context</a>().<a class="code" href="classcppcms_1_1http_1_1context.html#a0f6fe53deabd90fee0ced81a8df6404e">async_on_peer_reset</a>(</div><div class="line">                boost::bind(</div><div class="line">                    &amp;chat::remove_context,</div><div class="line">                    <a class="code" href="classbooster_1_1intrusive__ptr.html">booster::intrusive_ptr&lt;chat&gt;</a>(<span class="keyword">this</span>),</div><div class="line">                    call));</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="classcppcms_1_1rpc_1_1json__rpc__server.html#a14bfd8e7b5a2a8cfec7de5a8e9c1cc61">return_error</a>(<span class="stringliteral">&quot;Invalid position&quot;</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// handle client disconnect</span></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classcppcms_1_1application.html#a5806b5247fd3aa65b36947616305c626">remove_context</a>(<a class="code" href="classbooster_1_1shared__ptr.html">booster::shared_ptr&lt;cppcms::rpc::json_call&gt;</a> call)</div><div class="line">    {</div><div class="line">        waiters_.erase(call);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> broadcast(<span class="keywordtype">size_t</span> from)</div><div class="line">    {</div><div class="line">        <span class="comment">// update timeout</span></div><div class="line">        last_wake_ = <a class="code" href="group__manipulators.html#ga7ef04454ad2736a51c55c3cd0270d80c">time</a>(0);</div><div class="line">        <span class="comment">// Prepare response</span></div><div class="line">        <a class="code" href="classcppcms_1_1json_1_1value.html">cppcms::json::value</a> response = make_response(from);</div><div class="line">        <span class="comment">// Send it to everybody</span></div><div class="line">        <span class="keywordflow">for</span>(waiters_type::iterator waiter=waiters_.begin();waiter!=waiters_.end();++waiter) {</div><div class="line">            <a class="code" href="classbooster_1_1shared__ptr.html">booster::shared_ptr&lt;cppcms::rpc::json_call&gt;</a> call = *waiter;</div><div class="line">            call-&gt;<a class="code" href="classcppcms_1_1rpc_1_1json__call.html#a837bedb8818cc46e588ac7d868b17807">return_result</a>(response);</div><div class="line">        }</div><div class="line">        waiters_.clear();</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Prepare response to the client</span></div><div class="line">    <a class="code" href="classcppcms_1_1json_1_1value.html">cppcms::json::value</a> make_response(<span class="keywordtype">size_t</span> n)</div><div class="line">    {</div><div class="line">        <a class="code" href="classcppcms_1_1json_1_1value.html">cppcms::json::value</a> v;</div><div class="line"></div><div class="line">        <span class="comment">// Small optimization</span></div><div class="line">        v=<a class="code" href="namespacecppcms_1_1json.html#aefdab4e43ce88b19e1a73eecfe02d799">cppcms::json::array</a>();</div><div class="line">        <a class="code" href="namespacecppcms_1_1json.html#aefdab4e43ce88b19e1a73eecfe02d799">cppcms::json::array</a> &amp;ar  = v.<a class="code" href="classcppcms_1_1json_1_1value.html#aa883e6ec2f9d8c4a11bd48c6a4d40025">array</a>();</div><div class="line">        ar.reserve(messages_.size() - n);</div><div class="line"></div><div class="line">        <span class="comment">// prepare all messages</span></div><div class="line">        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=n;i&lt;messages_.size();i++) {</div><div class="line">            ar.push_back(messages_[i]);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> v;</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line"></div><div class="line">    <span class="comment">// message store</span></div><div class="line">    std::vector&lt;cppcms::json::value&gt; messages_;</div><div class="line"></div><div class="line">    <span class="comment">// long poll requests</span></div><div class="line">    <span class="keyword">typedef</span> std::set&lt;booster::shared_ptr&lt;cppcms::rpc::json_call&gt; &gt; waiters_type;</div><div class="line">    waiters_type waiters_;</div><div class="line"></div><div class="line">    <span class="comment">// timer for resetting idle requests</span></div><div class="line">    <a class="code" href="classbooster_1_1aio_1_1deadline__timer.html">booster::aio::deadline_timer</a> timer_;</div><div class="line">    time_t last_wake_;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="classcppcms_1_1rpc_1_1json__rpc__server.html#a59719adc406c2a762fd1c3363762539c">main</a>(<span class="keywordtype">int</span> argc,<span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        <a class="code" href="classcppcms_1_1service.html">cppcms::service</a> <a class="code" href="classcppcms_1_1application.html#ac026d7001308c5ce3af069099a4071e8">service</a>(argc,argv);</div><div class="line">        <a class="code" href="classbooster_1_1intrusive__ptr.html">booster::intrusive_ptr&lt;chat&gt;</a> c=<span class="keyword">new</span> chat(service);</div><div class="line">        service.applications_pool().mount(c);</div><div class="line">        service.run();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">catch</span>(std::exception <span class="keyword">const</span> &amp;e) {</div><div class="line">        std::cerr&lt;&lt;<span class="stringliteral">&quot;Catched exception: &quot;</span>&lt;&lt;e.what()&lt;&lt;std::endl;</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"><span class="comment">// vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4</span></div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Jul 11 2017 23:25:56 for CppCMS by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
